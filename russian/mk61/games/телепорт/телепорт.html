<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta content="true" name="HandheldFriendly">
	<meta content="width" name="MobileOptimized">
	<meta content="yes" name="apple-mobile-web-app-capable">
	<meta name="description" content="Телепорт. Игра. ПМК. МК-61">
	<title>Телепорт</title>

<style>

span.but, span.but_f, span.but_k, span.but_cx, span.but_b, span.reg, span.op_f, span.op_k {
	border:thin solid black;
	border-radius:4px;
	display:inline-block;
	font-size:1.1em;
	font-weight:bold;
	font-family:monospace;
	text-align:center;
	min-width:2.3em;
	white-space:nowrap;
}

sup {
	line-height:0;
}

span.but {
	background-color:#CCCCCC;
	color:black;
}

span.but_f {
	background-color:#F5E345;
	color:black;
}

span.but_k {
	background-color:LightSkyBlue;
	color:white;
}

span.but_cx {
	background-color:#F00505;
	color:white;
}

span.but_b {
	background-color:black;
	color:white;
}

span.reg {
	background-color:black;
	color:white;
}

span.op_f {
	background-color:black;
	color:yellow;
}

span.op_k {
	background-color:black;
	color:#00BFFF;
}

.code {
	background-color:#103810;
	color:#77FF77;
	font-size:1.1em;
	font-family:monospace;
	font-weight:bold;
	padding:1px 2px 1px 2px;
	white-space:pre;
}

table {
	border-collapse:collapse;
}

table, th, td {
	border:1px solid black;
}

.center {
	text-align:center;
}

details summary {
	cursor: pointer;
}
details summary > * {
	display: inline;
}

a[target="_blank"] {
	background: url(https://upload.wikimedia.org/wikipedia/commons/6/64/Icon_External_Link.png) center right no-repeat;
    padding-right: 0.8em;
}


</style>

</head>

<body>
	<header>
		<h1>Телепорт</h1>
	</header>

	<h2>Пролог</h2>
	<p>
		&hellip;оказывается у моего друга был телепорт! Индивидуальный!
		Да, таких почти нет, только госкорпорации владеют. Я только слышал, что есть
		частные. А уж заряды к ним стоят вообще космически. Но вот он прислал email
		и <q>подарок</q> и всё оказывается правдой.
	</p>
	<p>
		Вы же в курсе, что телепорты мы захватили в результате войны с пришельцами.
		Ну не войны, как оказалось, а борьбы с пиратами, только космического масштаба,
		которые хотели захватить местных недоразвитых аборигенов (нас), чтобы иметь
		ресурсную базу. Да, наше ядерное оружие приподнесло им сюприз и позволило
		продержаться какое-то время, пока не подоспела зональная полиция (в нашей
		зоне галактики). Пиратов убрали, нам оставили несколько новинок, что мы уже
		успели узнать. Дали участок космоса для развития, погрозили на всякий случай
		пальчиком и удалились. Сообщили, что как только разовъёмся, сами их найдём,
		а пока <q>маленькие</q>.
	</p>
	<p>
		Так вот про заряды. Я слышал домыслы, что есть станции по их производству.
		И теперь, судя по письму, не только есть, но мой друг был хранителем входа
		(точка, откуда можно телепортировать в хранилище). Сообщил что отправился
		разбираться с грабителями, но на всякий случай оставил мне сообщение и
		<q>подарок</q>, если вовремя не вернётся.
	</p>
	<p>
		И вот он <q>подарок</q> &ndash; телепорт и немного зарядов. Так же
		пространственные координаты планеты, где находится хранилище
		(по счастью кислородная). Точка входа уже разружена, навёл справки,
		так что на всякий случай перемещусь на саму планету. Заряды очень
		нужны. Без них телепорт превращается в безполезную и опасную (если
		криминал узнает) игрушку.
	</p>
	<p>
		Так, читаем <q>инструкцию</q> от друга. Этажей четыре, на каждом хранилище.
		Самое опасное - стражи (какие-то энергетические образования, пропускают
		только своих). <q>Своих</q> по историческим причинами (кто-то сделал
		эти станции, но человечеству это неизвестно) давно нет. За давностью или
		в силу экономии энергии стражи реагируют только на прохождение между
		комнатами, стараясь приблизиться к нарушителю. По счастью есть какие-то
		технологические люки, причем можно до них дотянуться и снизу.
		Так что перемещаясь между этажами (на каждом свой страж), и вычисляя
		приблизитель, кто где, можно их обмануть.
	</p>
	<p>
		Самое неприятное - внутри станции телепортация не работает. Точнее
		работает - но только для перемещения в хранилище (видимо хозяева
		придумали для экономии времени, их то считали за своих). Причём съедает
		заряды по дикому - за каждую комнату как за хороший кусок космического
		пространства. Только <q>хранитель входа</q>, который попадал на станцию
		с <q>правильной</q> точки, мог выйти. Ладно, слетаем (телепортом, конечно),
		вдруг что-то удасться сделать.
	</p>
	<p>
		Так, я на месте. Снаружи. Хорошая новость - станция есть. Причем одна стена разрушена,
		но при этом, судя но сигналам, осталась рабочей (не самоликвидировалась).
		Это значит можно будет зайти/выйти без проблем.
	</p>
	<p>
		Плохая новость &ndash; стражи действуют и самое неприятное - почти
		все лестницы разрушены (с <q>подняться</q> проблемы).
		Видимо внутри была <q>драчка</q> с применением каких-то
		разрушителей. Но и тут есть положительный момент - через дыры в
		переходах стало видно
		стражей. Можно не <q>вычислять</q> стражей, их просто видно.
		Ну что же, попробуем&hellip;
	</p>

	<h2>Задача</h2>
	<p>
		Необходимо набрать как можно больший уровень зарядов, не попадаясь
		страже. Заряды увеличиваются на 10 при каждом входе в хранилище по
		этажу (но не при телепортации или спрыгиванию сверху).
	</p>

	<h2>Игровой процесс</h2>
	<p>
		Здание четырёхэтажное, по 8 комнат на каждом этаже.
		Левая комната на каждом этаже &ndash; хранилище.
		Вы начинаете на первом этаже в правой части здания.
		Текущее положение игрока и стража определяется видеоизображением на
		экране ПМК: число с целой частью и шестнадцатеричными цифрами в дробной.
		Целая часть обозначает этаж, на котором вы находитесь. Каждая цифра
		дробной части обозначает комнаты слева направо, начиная после
		хранилища (хранилище самое левое и находится на месте цифры этажа):
	</p>
	<table>
		<tr>
			<th>Цифра</th>
			<th>Значение</th>
		</tr>
		<tr>
			<th><span class="code">-</span></th>
			<td>Пустая комната (пол)</td>
		</tr>
		<tr>
			<th><span class="code">L</span></th>
			<td>Комната с лестницей</td>
		</tr>
		<tr>
			<th><span class="code">8</span></th>
			<td>Комната, где находится игрок</td>
		</tr>
		<tr>
			<th><span class="code">9</span></th>
			<td>Комната с лестницей, где находится игрок</td>
		</tr>
		<tr>
			<th><span class="code">E</span></th>
			<td>Страж в пустой комнате</td>
		</tr>
		<tr>
			<th><span class="code"> </span></th>
			<td>Страж в комнате с лестницей (прячется)</td>
		</tr>
		<tr>
			<th><span class="code">C</span></th>
			<td>Игрок и страж в одной комнате вместе</td>
		</tr>
		<tr>
			<th><span class="code">Г</span></th>
			<td>Игрок и страж в одной комнате с лестницей</td>
		</tr>
	</table>
	<p>
		Вот типичное отображение:
		<span class="code"> 2.-Е-8--L   </span>. Этаж второй.
		Игрок в пятой комнате (слева), страж в третьей,
		лестница в конце в восьмой.
	</p>
	<p>
		Текущий уровень заряда для телепортации отображается в регистре Y
		(также хранится в регистре Rc).
		Вначале равен пяти. При телепортации уменьшается. При входе в хранилище &ndash;
		увеличивается на 10. Будьте внимательны &ndash; хранилище выдаёт заряды только
		восемь раз за игру (все хранилища суммарно, независимо от этажа).
	</p>
	<p>
		На каждом этаже свой страж, они двигаются независимо друг от друга.
		Когда страж в хранилище (под цифрой этажа), его отображение отсутствует.
		Когда игрок в хранилище &ndash; его изображение также отсутствует.
	</p>
	<p>
		Лестницы есть на каждом этаже, кроме последнего четвёртого (нет лестниц
		на крышу). Их количество и положение генерируется случайным образом
		в начале каждой игры. В среднем одна, реже две на этаж. Но т.&#8239;к.
		генерируется случайно, то иногда бывает и больше.
		Чем больше &ndash; тем легче играть (обойти стража).
		Лестниц в хранилище не бывает.
	</p>

	<h3>Начало</h3>
	<p>
		Положение переключателя Р-ГРД-Г во время игры должно быть в положении Р.
	</p>
	<p>
		Перед первым запуском задаём однократно вводимые на все игры значения
		в регистры. Если вы используете эмулятор, то эти данные уже записаны
		в регистры, как и программа.
	</p>
	<table>
		<tr>
			<th>Регистр</th>
			<th>Значение</th>
		</tr>
		<tr>
			<th>R6</th>
			<td>Псевдослучайное число. Можно оставить нулевым.</td>
		</tr>
		<tr>
			<th>R8</th>
			<td>-92 или -2 (так короче)</td>
		</tr>
		<tr>
			<th>Ra</th>
			<td>48</td>
		</tr>
		<tr>
			<th>Rb</th>
			<td>9.8888888</td>
		</tr>
		<tr>
			<th>Re</th>
			<td>
				<span class="code"> 8-------.   </span>
				План пустого этажа. Формируется так:
				<span class="but">5</span>,
				<span class="but">В&uarr;</span>,
				<span class="but">9</span>,
				<span class="but">&divide;</span>,
				<span class="but_k">К</span><span class="op_k">ИНВ</span>,
				<span class="but">ВП</span>,
				<span class="but">7</span>.
			</td>
		</tr>
	</table>
	<p>
		Затем нажимаем
		<span class="but_b">В/О</span>, <span class="but_b">С/П</span>
		для генерации плана здания и установки игрока в начальное положение.
	</p>

	<h3>Игра</h3>
	<p>
		Для выполнения действия нужно ввести цифру команду и нажать
		<span class="but_b">С/П</span>.
		Команда движения определяет направление положением цифр на клавиатуре
		относительно центра: 2,4,5,6,8. И отдельно 0
		(нуль-переход или телепортация).
	</p>
	<table>
		<tr>
			<th>Команда</th>
			<th>Действие</th>
		</tr>
		<tr>
			<th>0</th>
			<td>
				Телепортация в хранилище. Затрачиваются заряды в зависимости
				от расстояния (в комнатах) до хранилища.
				Если выполнить из самой правой &ndash; семь. Телепортация внутри
				хранилища игнорируется.
			</td>
		</tr>
		<tr>
			<th>2</th>
			<td>
				Ход вниз на этаж. Возможно везде, кроме первого этажа, где игнорируется.
				Фактически любое число &le; 3 воспринимается как ход вниз.
				Спускаться можно и в хранилище!
			</td>
		</tr>
		<tr>
			<th>4</th>
			<td>
				Ход влево. Из хранилища (из самой левой комнаты) ход игнорируется.
			</td>
		</tr>
		<tr>
			<th>5</th>
			<td>
				Выманивание. Игрок не двигается (открывая/закрывая межкомнатные двери,
				но не двигается), а страж приближается к нему.
			</td>
		</tr>
		<tr>
			<th>6</th>
			<td>
				Ход вправо. Для завершения игры нужно выйти правее
				границы здания на любом этаже.
			</td>
		</tr>
		<tr>
			<th>8</th>
			<td>
				Ход вверх. При отсутствии лестницы ход игнорируется.
				Фактически любое число &ge; 7 воспринимается как ход вверх.
			</td>
		</tr>
	</table>
	<p>
		Дробные числа как команды игнорируются (воспринимаются как ошибочный ввод, когда
		перед <span class="but_b">С/П</span> не указали команду).
		Можно использовать для просмотра текущего положения
		(если видеоизображение не на экране). Например,
		<span class="but_f">F</span><span class="op_f">&pi;</span>,
		<span class="but_b">С/П</span>
		просто покажет текущую ситуацию, ничего не меняя.
	</p>
	<p>
		При движении по этажу (влево/вправо) страж двигается в сторону игрока
		(страж реагируется на переходы).
		Если он оказывается в той же ячейке, что и игрок, то уничтожает
		нарушителя &ndash; <span class="code"> ЕГ0ГГ      </span>.
	</p>
	<p>
		При движении между этажами стражи <q>спят</q> (т.&#8239;к. двери не
		открываются, а страж пробуждается только при открытии дверей).
		Таким образом возможно даже попасть в одну комнату
		вместе со стражем. Но безопасно потом можно будет уйти
		верх (при наличии лестницы), вниз или телепортироваться в хранилище.
	</p>
	<p>
		При телепортации страж не двигается.
	</p>

	<h3>Окончание игры</h3>
	<p>
		Нормальное &ndash; выход в правой части здания. В этом случае при
		остановке покажет текущий уровень зарядов. Уровень заряда &gt; 5
		означает, что ваша миссия удачна (набрали больше, чем вначале).
		Для начала новой игры нажмите <span class="but_b">С/П</span>.
	</p>
	<p>
		Если произошла трагедия (<span class="code"> ЕГ0ГГ      </span>),
		то нажав <span class="but">В&uarr;</span> можно узнать причину.
		Если ноль &ndash; страж поймал, если &lt; 0, то не хватило заряда
		при телепортации и игрок <q>пропал в подпространстве</q>.
		Для начала новой игры нажмите <span class="but_b">С/П</span>.
	</p>

	<hr>

	<details>
		<summary>
			<h2>Разбор программы</h2>
		</summary>

		<h3>Распределение регистров</h3>
		<table>
			<tr>
				<th>R0</th>
				<td>
					Количество попыток использования хранилища минус один.
					Инициализируется программно значением из Rb.
				</td>
			</tr>
			<tr>
				<th>R1…R4</th>
				<td>
					План 1…4 этажей. Генерируется программно.
					Каждый этаж представляется числом, где целая часть
					обозначает положение стража
					на этаже: [0…7], а дробная часть представляет
					план лестниц на этаже, состоящая из нулей
					и единиц в нужном разряде. Каждой единице соответствует
					лестница.
					Лестниц на крышу нет, поэтому R4 всегда целое.
				</td>
			</tr>
			<tr>
				<th>R5</th>
				<td>
					Рабочий регистр. Обычно хранит 10<sup>m</sup>, где
					m &ndash; положение игрока на этаже: [0…7].
					Но при телепортации хранит значение сдвига влево
					(отрицательное число).
				</td>
			</tr>
			<tr>
				<th>R6</th>
				<td>
					Псевдослучайное число, используемое для генерации плана здания.
					Программный генератор псевдослучайных чисел использует
					формулу X<sub>i+1</sub> = {X<sub>i</sub> &times; 7 + &pi;}.
				</td>
			</tr>
			<tr>
				<th>R7</th>
				<td>
					Положение игрока на этаже: [0…7].
					Инициализируется программно семёркой.
				</td>
			</tr>
			<tr>
				<th>R8</th>
				<td>
					Константа <q>&minus;92</q> &ndash; адрес блока движения стража
					по этажу. Отрицательность значения используется для контроля
					выхода игрока из здания (завершение игры).
				</td>
			</tr>
			<tr>
				<th>R9</th>
				<td>
					Номер этажа, на котором находится игрок: [1…4].
					Инициализируется программно единицей.
				</td>
			</tr>
			<tr>
				<th>Ra</th>
				<td>
					Константа 48 &ndash; адрес блока программы по отображению
					текущего положения игрока и остановкой с ожиданием команды.
					По сути начало основного цикла программы
					(шесть косвенных переходов в программе используют этот регистр).
				</td>
			</tr>
			<tr>
				<th>Rb</th>
				<td>
					Константа 9.8888888.
					Все цифры, кроме первой, используется как битовая маска для
					выделения цифр, содержащих бит 3 (цифры 8 и 9).
					Целая часть &ndash; начальное значение счётчика
					использования хранилища (зарядки телепорта).
					Получается максимум 9 &minus; 1 = 8 раз	на игру.
					Если это кажется недостаточным, то можно указать значение
					18.888888 или 28.888888 и т.&#8239;п.
				</td>
			</tr>
			<tr>
				<th>Rс</th>
				<td>
					Накопленный объём зарядов для телепорта.
					Инициализируется программно пятёркой (цифра по адресу 03).
				</td>
			</tr>
			<tr>
				<th>Rd</th>
				<td>
					Рабочий регистр. Хранит последнее видеоизображение.
					Фактически используется
					как битовая маска для проверки возможности подняться по
					лестнице (только бит 0 у цифр важен, остальные не учитываются).
					Отличие от значения в
					<span class="but_k">К</span><span class="but_b">П&rarr;x</span><span class="but_b">9</span>
					в том, что целая часть всегда есть.
				</td>
			</tr>
			<tr>
				<th>Re</th>
				<td>
					Константа <span class="code"> 8-------.   </span>
					Используется как битовая маска при генерации видеоизображения.
					И как адрес перехода на процедуру выдачи ошибки при
					<q>фатальных</q> ходах игрока.
				</td>
			</tr>
		</table>

		<h3>Текст программы</h3>
		<table class="center">
			<tr>
				<th>&#8202;#&#8202;|&#8202;</th>
				<th>00</th>
				<th>01</th>
				<th>02</th>
				<th>03</th>
				<th>04</th>
				<th>05</th>
				<th>06</th>
				<th>07</th>
				<th>08</th>
				<th>09</th>
			</tr>
			<tr>
				<th>&#8202;00&#8202;|&#8202;</th>
				<td><span class="but_cx">Cx</span></td>
				<td><span class="but_b">x&rarr;П</span><span class="but">4</span></td>
				<td><span class="but_b">x&rarr;П</span><span class="but">1</span></td>
				<td><span class="but">5</span></td>
				<td><span class="but_b">x&rarr;П</span><span class="reg">c</span></td>
				<td><span class="but_f">F</span><span class="op_f">Ln</span></td>
				<td><span class="but_b">x&rarr;П</span><span class="but">9</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="but">6</span></td>
				<td><span class="but_k">К</span><span class="op_k">{x}</span></td>
				<td><span class="but">7</span></td>
			</tr>
			<tr>
				<th>&#8202;10&#8202;|&#8202;</th>
				<td><span class="but_b">x&rarr;П</span><span class="but">7</span></td>
				<td><span class="but">&times;</span></td>
				<td><span class="but_f">F</span><span class="op_f">&pi;</span></td>
				<td><span class="but">+</span></td>
				<td><span class="but_b">x&rarr;П</span><span class="but">6</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="reg">b</span></td>
				<td><span class="but_b">x&rarr;П</span><span class="but">0</span></td>
				<td><span class="but_k">К</span><span class="op_k">&and;</span></td>
				<td><span class="but_k">К</span><span class="op_k">{x}</span></td>
				<td><span class="but_k">К</span><span class="op_f">x&ne;0</span><span class="but">4</span></td>
			</tr>
			<tr>
				<th>&#8202;20&#8202;|&#8202;</th>
				<td><span class="but">8</span></td>
				<td><span class="but">&divide;</span></td>
				<td><span class="but_k">К</span><span class="but_b">x&rarr;П</span><span class="but">1</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="but">1</span></td>
				<td><span class="but_k">К</span><span class="op_f">x&ge;0</span><span class="but">7</span></td>
				<td><span class="but_k">К</span><span class="op_k">{x}</span></td>
				<td><span class="but_k">К</span><span class="but_b">x=0</span><span class="reg">a</span></td>
				<td><span class="but_f">F</span><span class="op_f">Вx</span></td>
				<td><span class="but">5</span></td>
				<td><span class="but">&minus;</span></td>
			</tr>
			<tr>
				<th>&#8202;30&#8202;|&#8202;</th>
				<td><span class="but_k">К</span><span class="op_f">x&ne;0</span><span class="but">8</span></td>
				<td><span class="but_f">F</span><span class="op_f">1/x</span></td>
				<td><span class="but_k">К</span><span class="op_k">[x]</span></td>
				<td><span class="but_f">F</span><span class="op_f">x=0</span></td>
				<td><span class="but">77</span></td>
				<td><span class="but_f">F</span><span class="op_f">Вx</span></td>
				<td><span class="but_f">F</span><span class="op_f">x&ge;0</span></td>
				<td><span class="but">43</span></td>
				<td><span class="but_k">К</span><span class="but_b">П&rarr;x</span><span class="but">5</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="but">5</span></td>
			</tr>
			<tr>
				<th>&#8202;40&#8202;|&#8202;</th>
				<td><span class="but_b">П&rarr;x</span><span class="reg">d</span></td>
				<td><span class="but_k">К</span><span class="op_k">&and;</span></td>
				<td><span class="but_k">К</span><span class="op_k">{x}</span></td>
				<td><span class="but_k">К</span><span class="op_k">ЗН</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="but">9</span></td>
				<td><span class="but">+</span></td>
				<td><span class="but_k">К</span><span class="op_f">x&ne;0</span><span class="reg">a</span></td>
				<td><span class="but_b">x&rarr;П</span><span class="but">9</span></td>
				<td><span class="but">4</span></td>
				<td><span class="but_k">К</span><span class="but_b">П&rarr;x</span><span class="but">9</span></td>
			</tr>
			<tr>
				<th>&#8202;50&#8202;|&#8202;</th>
				<td><span class="but_k">К</span><span class="op_k">[x]</span></td>
				<td><span class="but_f">F</span><span class="op_f">10<sup>x</sup></span></td>
				<td><span class="but">&divide;</span></td>
				<td><span class="but_k">К</span><span class="but_b">П&rarr;x</span><span class="but">9</span></td>
				<td><span class="but">+</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="but">7</span></td>
				<td><span class="but_f">F</span><span class="op_f">10<sup>x</sup></span></td>
				<td><span class="but_b">x&rarr;П</span><span class="but">5</span></td>
				<td><span class="but">2</span></td>
				<td><span class="but">+</span></td>
			</tr>
			<tr>
				<th>&#8202;60&#8202;|&#8202;</th>
				<td><span class="but_k">К</span><span class="op_k">&or;</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="reg">e</span></td>
				<td><span class="but_k">К</span><span class="op_k">&oplus;</span></td>
				<td><span class="but_b">x&rarr;П</span><span class="reg">d</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="reg">c</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="but">9</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="reg">d</span></td>
				<td><span class="but">&lt;-&gt;</span></td>
				<td><span class="but_f">F</span><span class="op_f">&orarr;</span></td>
				<td><span class="but">ВП</span></td>
			</tr>
			<tr>
				<th>&#8202;70&#8202;|&#8202;</th>
				<td><span class="but_b">С/П</span></td>
				<td><span class="but_f">F</span><span class="op_f">x=0</span></td>
				<td><span class="but">25</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="but">7</span></td>
				<td><span class="but_k">К</span><span class="op_f">x&ne;0</span><span class="reg">a</span></td>
				<td><span class="but">/-/</span></td>
				<td><span class="but_b">x&rarr;П</span><span class="but">5</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="but">7</span></td>
				<td><span class="but">+</span></td>
				<td><span class="but_k">К</span><span class="op_f">x&ge;0</span><span class="reg">a</span></td>
			</tr>
			<tr>
				<th>&#8202;80&#8202;|&#8202;</th>
				<td><span class="but_b">x&rarr;П</span><span class="but">7</span></td>
				<td><span class="but_k">К</span><span class="but_b">x=0</span><span class="but">8</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="but">5</span></td>
				<td><span class="but_f">F</span><span class="op_f">L0</span></td>
				<td><span class="but">86</span></td>
				<td><span class="but_k">К</span><span class="but_b">x&lt;0</span><span class="but">8</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="reg">c</span></td>
				<td><span class="but">+</span></td>
				<td><span class="but_k">К</span><span class="op_f">x&ge;0</span><span class="reg">e</span></td>
				<td><span class="but_b">x&rarr;П</span><span class="reg">c</span></td>
			</tr>
			<tr>
				<th>&#8202;90&#8202;|&#8202;</th>
				<td><span class="but_b">П&rarr;x</span><span class="but">5</span></td>
				<td><span class="but_k">К</span><span class="op_f">x&ge;0</span><span class="reg">a</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="but">7</span></td>
				<td><span class="but_k">К</span><span class="but_b">П&rarr;x</span><span class="but">9</span></td>
				<td><span class="but">&minus;</span></td>
				<td><span class="but_f">F</span><span class="op_f">tg<sup>-1</sup></span></td>
				<td><span class="but_k">К</span><span class="op_k">[x]</span></td>
				<td><span class="but_k">К</span><span class="op_f">x&ne;0</span><span class="reg">e</span></td>
				<td><span class="but_k">К</span><span class="but_b">П&rarr;x</span><span class="but">9</span></td>
				<td><span class="but">+</span></td>
			</tr>
			<tr>
				<th>&#8202;A0&#8202;|&#8202;</th>
				<td><span class="but_k">К</span><span class="but_b">x&rarr;П</span><span class="but">9</span></td>
				<td><span class="but_k">К</span><span class="but_b">П&rarr;x</span><span class="but">7</span></td>
				<td><span class="but_k">К</span><span class="but_b">x&lt;0</span><span class="reg">a</span></td>
				<td><span class="but_b">П&rarr;x</span><span class="reg">c</span></td>
				<td><span class="but_b">С/П</span></td>
				<td colspan="5"></td>
			</tr>
		</table>

		<h3>Объяснение работы программы</h3>

		<p>
			Иерархически программу можно представить так:
		</p>
		<ul>
			<li>
				Блок начальной инициализации и генерации плана здания.
				Адреса [00…24].
			</li>
			<li>
				Основной цикл программы. Адреса [25…A4].
				<ol>
					<li>
						Блок отображения текущего положения игрока и уровня
						заряда. Адреса [48…70]. Начальный адрес
						храниться в регистре Ra.
					</li>
					<li>
						Блок разбора команды игрока и выбора процедуры обработки.
						Адреса [71…72], [25…34].
					</li>
					<li>
						Блок обработки движения между этажами (вверх/вниз).
						Адреса [35…47].
					</li>
					<li>
						Блок обработки движения по этажу (влево/вправо).
						Адреса [77…80].
					</li>
					<li>
						Блок телепортации.
						Адреса [73…76].
					</li>
					<li>
						Блок обработки работы хранилища.
						Адреса [81…91].
					</li>
					<li>
						Блок движения стража. И контроль завершения игры.
						Адреса [92…A4].
					</li>
					<li>
						Блок обработки ошибки.
						Адрес AA.
					</li>
				</ol>
			</li>
		</ul>
		<p>
			Теперь разберём каждый блок детальней.
		</p>

		<h4>Блок начальной инициализации</h4>
		<p>
			Который сразу после <span class="but_b">В/О</span> <span class="but_b">С/П</span>.
			Т.&#8239;к. на 4-м этаже нет люков в потолке, то нет и лестниц. Поэтому
			R4 зануляем.
		</p>
		<p>
			Также зануляем R1, который будет
			использоваться как <q>отрицательный</q> счётчик цикла. Эта хитрость
			связана с использованием особенностей косвенной адресации.
		</p>
		<p>
			Начальное значение уровня зарядов (5) вносим в Rc.
			Можно модифицировать программу, указав другое, но допустимыми
			значениями являются только числа из диапазона [3…7].
		</p>
		<p>
			Далее идёт установка начального значения номера этажа (=1), но
			необычно, через <span class="but_f">F</span><span class="op_f">Ln</span>.
			В этом случае будет единица с чем-то, но это <q>с чем-то</q> при
			косвенной адресации по R9 будет отброшено. Причина использования
			именно функции, а не просто единицы будет объяснена позднее. Также
			становить понятны граничные значения на начальное значение
			уровня заряда &ndash; чтобы логарифм дал единицу.
		</p>
		<p>
			Далее по адресам [07…14] генерируется очередное
			псевдослучайное число по формуле X<sub>i+1</sub> = {X<sub>i</sub> &times; 7 + &pi;}.
			Причём коэффициент
			умножения (7) также сохраняется в R7, как начальное положения
			игрока на этаже. Псевдослучайное число храниться вместе с целой
			частью, чтобы были заполнены все цифры мантиссы.
		</p>
		<p>
			Битовая конъюнкция с числом из Rb оставит восьмёрки на тех местах,
			где были цифры 8 или 9. В среднем они встречаются в 1/5 случае,
			а значит на этаже будет в среднем 7/5 лестниц, что соответствует
			<q>почти все сломаны</q>.
			Одновременно инициализируется R0, как начальное значение счётчика
			использования хранилища.
		</p>
		<p>
			Исходно стражи находятся в хранилище, т.&#8239;е. с нулевой
			координатой, поэтому оставляем только дробную часть. А команда
			<span class="but_k">К</span><span class="op_f">x&ne;0</span><span class="but">4</span>
			проверяет, что сгенерировалась хотя бы одна лестница. Если этаж
			получился пустой, то начнём генерацию сначала переходя на адреса 01
			(R4 = 0, косвенно +1) с текущим нулевым регистром X.
			Как альтернативу можно использовать
			<span class="but_k">К</span><span class="op_f">x&ne;0</span><span class="but">9</span>.
		</p>
		<p>
			Далее цифры 8 в числе превращаются в единички, путём деления на 8.
		</p>
		<p>
			Стоит пояснить, куда же идёт сохранение. При начальном значении R1 = 0
			косвенная адресация превратит его в &minus;99999999, что соответствует
			регистру R3. В следующий цикл в &minus;99999998, что соответствует R2,
			потом в &minus;99999997, что соответствует R1, т.&#8239;е. счётчик будет
			перезаписан планом первого этажа. Детально можно ознакомиться в документе
			<a href="https://sergeanvarov.github.io/russian/mk61/uf/indirect_addr.html" target="_blank">
				Недокументированные возможности</a
			>.
			Т.&#8239;к. до последнего случая счётчик всё время
			отрицательный, то команды
			<span class="but_b">П&rarr;x</span><span class="but">1</span>,
			<span class="but_k">К</span><span class="op_f">x&ge;0</span><span class="but">7</span>
			как раз проверяют это факт. Причём начало цикла (адрес 07) <q>удачно</q>
			совпадает с начальным значением R7.
		</p>
		<p>
			На этом блок начальной инициализации закончен. Хочу только пояснить,
			что последующие две команды другого блока безусловно отправят
			программу на адрес в Ra, т.&#8239;к. план этажа &ndash; это не нулевое
			дробное число.
		</p>

		<h4>1. Блок отображения</h4>
		<p>
			Начинается с адреса 48 (Ra). В качестве бита положения стража
			используется 4 (бит 2). Для его фиксации в нужном разряде
			можно использовать два подхода:
		</p>
		<ol>
			<li>
				Использовать 10<sup>n</sup> + 4, где n = [0…7] &ndash; это
				положения стража на этаже (целая часть плана этажа).
			</li>
			<li>
				Использовать 4 / 10<sup>n</sup>. В этом случае для битовых
				операций нужно ещё добавить целую часть.
			</li>
		</ol>
		<p>
			В программе используется второй подход, потому что нам нужно будет
			к числу добавить план лестниц этажа, которая представляется
			дробным числом. От извлечённого через Rd плана этажа берётся целая
			часть, возводиться в степень, а потом 4 делиться на него. В случае,
			если начальное положение стража = 0, то 10<sup>0</sup> = 1 и
			результат будет равен 4 (страж не виден, но число содержит
			целую часть). Если страж уже вышел, то и целая часть числа уже будет
			не нулевая. Поэтому последующее сложение
			<span class="but_k">К</span><span class="but_b">П&rarr;x</span><span class="but">9</span>
			<span class="but">+</span>
			всегда будет содержать незначащую для битовых операций целую часть.
		</p>
		<p>
			Далее выполняется аналогичное действие для положения игрока, но используется
			подход 1 (для разнообразия). Положения игрока для
			отображения задаётся двойкой (бит 1), точнее отсутствием такого бита.
			Промежуточное 10<sup>m</sup>, кроме того, сохраняется в R5 &ndash;
			оно нам пригодится.	Бит 1 <q>прибавляется</q> к итогу командой
			по адресу 60.
		</p>
		<p>
			Полученная маска далее с помощью
			<span class="but_k">К</span><span class="op_k">&oplus;</span>
			совмещается с планом пустого этажа из Re, автоматически исключая
			бит положения игрока. При этом дробная часть
			уже правильная, но целая часть, как у всех бинарных операций ПМК,
			равна 8. Само число, в котором нам важны только
			биты 0 (лестницы) сохраняется в Rd.
		</p>
		<p>
			А далее идёт <q>шаманство</q>,
			которое так же описано в другом разделе документа
			<a href="https://sergeanvarov.github.io/russian/mk61/uf/x2.html#id_exp_combine" target="_blank">
				Недокументированные возможности</a
			>, вписывающее номер этажа в первый разряд.
			Замечу, что в пошаговом режиме это не сработает и номер этажа
			останется только в X1.
			Начальное
			<span class="but_b">П&rarr;x</span><span class="reg">c</span> &ndash;
			уровень заряда, перед остановкой попадёт в регистр Y.
		</p>

		<h4>2. Блок разбора команды игрока</h4>
		<p>
			Быстро пропустим проверку на телепортацию (адреса [71…72]) и сразу
			перейдём к адресу 25. Тут идёт <q>защита от дурака</q> &ndash;
			проверка случайного нажатия <span class="but_b">С/П</span> без
			ввода цифры команды. В этом случае в регистре X останется
			видеоизображение, содержащее дробную часть. Именно этой проверкой и
			занимаются три первые команды.
		</p>
		<p>
			Затем от числа команды отнимается 5. Результат и последующий
			выбор процедуры проще отобразить таблицей, чтобы понять, что получится.
		</p>
		<table>
			<tr>
				<td>Команда\операция</td>
				<th><span class="but">5</span>, <span class="but">&minus;</span></th>
				<th><span class="but_f">F</span><span class="op_f">1/x</span></th>
				<th><span class="but_k">К</span><span class="op_k">[x]</span></th>
			</tr>
			<tr>
				<th>2</th>
				<td>-3</td>
				<td>-1/3</td>
				<td>0, в X1 число &lt; 0</td>
			</tr>
			<tr>
				<th>4</th>
				<td>-1</td>
				<td>-1</td>
				<td>-1</td>
			</tr>
			<tr>
				<th>5</th>
				<td colspan="3">0 &ndash; это сразу уйдёт на движение стража</td>
			</tr>
			<tr>
				<th>6</th>
				<td>1</td>
				<td>1</td>
				<td>1</td>
			</tr>
			<tr>
				<th>8</th>
				<td>3</td>
				<td>1/3</td>
				<td>0, в X1 число &gt; 0</td>
			</tr>
		</table>
		<p>
			Фактически, вместо 2 может быть любое число &lt; 4, а вместо
			8 число &gt; 6.
			Это дополнительная <q>защита от дурака</q> &ndash; программа учитывает все
			возможные варианты ввода. Далее идёт переход (по нулевому результату)
			на блок движения между этажами или по &plusmn;1 &ndash; на
			блок движения по этажу.
		</p>

		<h4>3. Блок обработки движения между этажами (вверх/вниз)</h4>
		<p>
			Начиная с адреса 35. Как указано выше, для нас важен только знак
			числа в X1, поэтому после восстановления X1&rarr;X делается
			проверка. Вариант
			X &lt; 0 будет обработан автоматически позднее, потому что
			вниз пойти можно почти всегда, а вот вариант с
			<q>вверх</q> посложней.
		</p>
		<p>
			Нужно проверить, что есть лестница.
			Для этого сначала получаем бит в позиции игрока. Т.&#8239;к. в R5
			было сохранено 10<sup>m</sup>, то 10<sup>m</sup> + 1 даст нужный бит,
			поэтому сначала идёт косвенное извлечение из R5, чтобы в нём прошло
			+1, а затем этот бит <q>умножается</q> на бит лестниц из сохранённого
			ранее в Rd. Знак числа от дробной части даст 1 (для лестницы) или
			ноль, при её отсутствии. На 4-м этаже лестниц нет, так что выход
			на крышу проверять отдельно не нужно.
		</p>
		<p>
			Этот же фрагмент идёт и для хода вниз, только тут сразу знак даёт
			&minus;1 для отрицательных значений. Полученное значение 0 или
			&plusmn;1 складывается с номером этажа. При этом делается проверка,
			что бы мы не провалились в подвал, т.&#8239;е. чтобы номер этажа
			был не нулевой.
			Окончание этого блока, опять <q>удачно</q> попадает без перехода
			на блок отображения.
		</p>

		<h4>4. Блок обработки движения по этажу (влево/вправо)</h4>
		<p>
			С адреса 77. Тут вообще просто. Вспоминая, что команда игрока будет
			преобразована в &plusmn;1, это значение просто складывается с
			текущим положением. Дополнительная проверка делается, чтобы игрок
			из хранилища не ушёл влево (в минус).
		</p>

		<h4>5. Блок телепортации</h4>
		<p>
			Начиная с адреса 73. Его функции также встречаются в блоке обработки
			работы хранилища.
		</p>
		<p>
			Тоже довольно тривиально. Сначала проверяется, что игрок не в
			хранилище, откуда некуда телепортироваться. Затем значение инвертируется
			(берётся с обратным знаком)	и <q>удачно</q> (опять)
			вливается в блок движения по этажу. Понятно, что далее результат
			сложения даст ноль, и мы перейдём в блок обработки работы хранилища.
			В R5 у нас отрицательное число.
		</p>

		<h4>6. Блок обработки работы хранилища</h4>
		<p>
			С адреса 81. Первым делом проверяется, что текущее положения игрока
			получилось нулевым (в хранилище). Если нет, то переход на блок
			движения стража (с адреса в R8). Вторым делом извлекается содержимое R5.
			Если мы зашли в хранилище <q>ногами</q>, то в R5 будет 10, как
			10<sup>1</sup>, потому что до этого	положения игрока на этаже
			было равно единице. Если как результат телепортации, то в диапазоне
			[-7…-1].
		</p>
		<p>
			Сначала делается проверка, что количество попыток получения заряда
			не исчерпано.
			Если счётчик достигнет единицы, то выполниться команда
			<span class="but_k">К</span><span class="but_b">x&lt;0</span><span class="but">8</span>,
			которая пропустит только при телепортации (R5 &lt; 0), но
			проигнорирует зарядку (R5 = 10), переходя сразу на блок движения
			стража. Из-за того, что проверка делается <q>ДО</q>, количество
			попыток на единицу меньше начального значения в R0.
		</p>
		<p>
			Проверка суммы заряда по адресу 89
			<span class="but_k">К</span><span class="op_f">x&ge;0</span><span class="reg">e</span>,
			используется только при телепортации, т.&#8239;к. при далёкой
			телепортации мы можем получить и минус. Что приведёт к переходу на ошибку.
			Для обычного движения проверка всегда отработает успешно,
			потому что мы только что добавили 10.
		</p>
		<p>
			Проверка по адресу [90…91] позволит сразу уйти на начало цикла программы
			при телепортации (R5 &lt; 0), и <q>удачно</q> перейти на блок
			движения стража, при обычном входе в хранилище (R5 = 10).
		</p>

		<h4>7. Блок движения стража</h4>
		<p>
			С адреса 92 (регистр R8). Страж поймает игрока, если расстояние от
			него до нового положения игрока &le;1.
			Положение игрока в R7, а стража &ndash; целая часть от
			<span class="but_k">К</span><span class="but_b">П&rarr;x</span><span class="but">9</span>.
		</p>
		<p>
			Тут нам на помощь приходят знания тригонометрии, а именно функции
			arctg, которая для чисел в диапазоне (&minus;&pi;/2&hellip;+&pi;/2),
			что приблизительно [-1.5&hellip;1.5],
			даёт результат меньше единицы (по модулю). И эта функция сохраняется знак.
			Это то, что нам нужно (вот почему важно Р-ГРД-Г переключить в радианы).
			Более того, мы можем не убирать дробную часть
			плана этажа, т.&#8239;к. и с ней результат уложиться в этот диапазон.
			С учётом этого после команд
			<span class="but_f">F</span><span class="op_f">tg<sup>-1</sup></span>
			<span class="but_k">К</span><span class="op_k">[x]</span>
			останется &plusmn;1, если страж далеко от игрока, или ноль, если
			рядом. В этом случае идёт переход на блок ошибки. А если всё хорошо,
			то эта &plusmn;1 прибавляется к плану этажа.
		</p>
		<p>
			Завершающая проверка
			<span class="but_k">К</span><span class="but_b">П&rarr;x</span><span class="but">7</span>
			используется тот факт, что в R8 число отрицательное
			(в других регистрах &lt; 8 &ndash; нет), поэтому если игрок вышел из здания
			(положение R7 = 8), то так мы узнаем об этом.
		</p>
		<p>
			При выходе просто показываем уровень заряда (наши достижения).
			Если затем нажать <span class="but_b">С/П</span>, то будет
			выполнение короткой и длинной побочной ветви программы, которые
			опять же описаны здесь:
			<a href="https://sergeanvarov.github.io/russian/mk61/uf/id_addr_space.html" target="_blank">
				Недокументированные возможности</a
			>.
			Но команда
			<span class="but_k">К</span><span class="op_f">x&ge;0</span><span class="but">7</span>
			по адресу 24 вернёт программу в основную ветвь исполнения.
			Это очередная <q>защита от дурака</q> (на начало без
			<span class="but_b">В/О</span>).
		</p>

		<h4>8. Блок обработки ошибки</h4>
		<p>
			Да, всего одна команда. Так уж получилось (снова удачно), что маска пустого этажа
			из Re заканчивается на AA (--), а малой ветви исполнения (адрес AA
			уже вне диапазона) соответствует адрес 05. Тот самый логарифм.
			Вот он зачем. На него мы переходим с регистром X &le; 0,
			т.&#8239;е. логарифм всегда выдаст ошибку. А команда
			<span class="but">В&uarr;</span> поможет показать, из-за чего
			именно ошибка.
		</p>
		<p>
			Более того, при ошибке
			одна команда по адресу AB (адрес 06) будет пропущена (это тоже описано
			в упомянутом выше документе) и следующим будет адрес AC (или 00), но
			уже в длинной ветви исполнения, которая, как и ранее, прервётся по
			<span class="but_k">К</span><span class="op_f">x&ge;0</span><span class="but">7</span>
			на 24-м адресе.
			Это значит, после ошибки можно смело сразу нажимать
			<span class="but_b">С/П</span> для начала новой игры.
			Снова <q>защита от дурака</q>, чтобы программа не выполнялась
			после фактического завершения.
		</p>

		<h3>История программы</h3>
		<p>
			Идею программы я взял с другой, которую позднее выложили на ресурс
			<a href="https://www.lordbss.pp.ru/pmk191.html" target="_blank">Замок с призраками</a>.
			Хотя та программа и содержит незначительные ошибки и отсутствие некоторых проверок
			(как и последующий ремикс, который уже при первом запуске
			не показывает положения игрока), главное недовольство вызывало то,
			что игра была фактически на двоих.
			Один должен был придумать план замка, который пройти возможно,
			тщательно вбить с кучей начальных параметров. А другой один разочек пройти (для
			второго разочка снова нужен первый или нудно вбивать все параметры,
			частично раскрывая информацию).
		</p>
		<p>
			Поэтому первым делом убрал запрет прохождения лестниц, которые сильно
			затрудняют прохождение, и добавил автогенерацию плана здания. Это сильно
			прибавило в динамике и позволило играть одному. Т.&#8239;к.
			исходная программа и так была <q>полной</q>, используя все регистры,
			пришлось менять подходы к хранению и обработке. Заодно сменил способ
			отображения информация, т.&#8239;к. считать <q>пустые</q> места на
			экране (как в исходной программе), для определения текущего положения,
			очень неудобно. То ли три знакоместа, то ли четыре. То ли в конце
			стоит, то ли нет. Кстати, первый датчик псевдослучайных чисел был
			<q>не очень</q>, но зато короткий. Позднее использовал датчик
			получше.
		</p>
		<p>
			Далее пришлось оптимизировать, чтобы все параметры
			инициализировались автоматически. Потом ещё, поиграв немного,
			оптимизировать для внедрения <q>защиты от дурака</q> и проверке
			всех границ. Заодно	добавил совмещение номера этажа с планом,
			что упростило использование.
		</p>
		<p>
			Несмотря на это, практика показала, что всё равно трудно проходить.
			Так и появился телепорт. Сначала на произвольное, задаваемое игроком,
			расстояние. Но тогда получалось слишком легко. Игрок при необходимости
			просто <q>перепрыгивал</q> стража. Оставил только телепортацию в хранилище.
		</p>
		<p>
			Часть идей отбрасывалась, например индикацию факта нахождения
			игрока в хранилище, как не очень нужную, но требующую
			дополнительных команд. Часть функционала добавлялась, например,
			<q>удерживания</q> стража на месте при телепортации.
		</p>
		<p>
			Некоторые лабиринты генерируются такими, что можно бесконечно
			заряжаться. Так появилось ограничения на количество
			попыток использования хранилища.
		</p>
		<p>
			И каждый раз приходилось выдумывать новые способы
			оптимизировать, чтобы влезть в 105 адресов и 15 регистров.
			Каждое <q>удачно</q> &ndash; несколько часов раздумий и
			многократных переделок программы. И если в игровом плане программа
			может показаться не сложной, то основное удовольствие я получил,
			когда смог таки сделать то, что получилось.
		</p>
	</details>

</body>

</html>